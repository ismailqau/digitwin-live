version: '3.8'

services:
  api-gateway:
    image: api-gateway:local
    ports:
      - '3000:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=postgresql://ismail@host.docker.internal:5432/digitwinlive-db
      - JWT_SECRET=3h1Jy0SGM+u+CeMhCT98lLbDfrri6pGzFNXiPpRCnIc=
      - REFRESH_SECRET=V2yKGotlGfpeaM4z78KsiGrpsTbW1TYiiVnBJ9XO2uI=
      - CORS_ORIGIN=*
      - GCP_PROJECT_ID=digitwinlive
      - GCP_REGION=us-central1
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 3

  websocket-server:
    image: websocket-server:local
    ports:
      - '3001:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=postgresql://ismail@host.docker.internal:5432/digitwinlive-db
      - JWT_SECRET=3h1Jy0SGM+u+CeMhCT98lLbDfrri6pGzFNXiPpRCnIc=
      - REFRESH_SECRET=V2yKGotlGfpeaM4z78KsiGrpsTbW1TYiiVnBJ9XO2uI=
      - CORS_ORIGIN=*
      - GCP_PROJECT_ID=digitwinlive
      - GCP_REGION=us-central1
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 3

  face-processing:
    image: face-processing:local
    ports:
      - '8001:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=postgresql://ismail@host.docker.internal:5432/digitwinlive-db
      - GCP_PROJECT_ID=digitwinlive
      - GCP_REGION=us-central1
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 3

  qwen3-tts-service:
    image: qwen3-tts-service:local
    ports:
      - '8002:8001'
    environment:
      - PORT=8001
      - HOST=0.0.0.0
      - MODEL_CACHE_DIR=/app/models
      - CUSTOM_VOICE_MODEL=Qwen/Qwen3-TTS-12Hz-1.7B-CustomVoice
      - BASE_MODEL=Qwen/Qwen3-TTS-12Hz-1.7B-Base
      - TOKENIZER_MODEL=Qwen/Qwen3-TTS-Tokenizer-12Hz
      - MAX_TEXT_LENGTH=2000
      - USE_VLLM=false
    volumes:
      - ./services/qwen3-tts-service/models:/app/models
      - ./services/qwen3-tts-service/logs:/app/logs
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8001/health']
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3
    restart: unless-stopped
